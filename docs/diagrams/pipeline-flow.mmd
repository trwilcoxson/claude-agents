%%{init: {"theme": "base", "themeVariables": {"primaryColor": "#f5f5f5", "primaryTextColor": "#1a1a2e", "primaryBorderColor": "#555", "lineColor": "#4a4a6a", "secondaryColor": "#e8eaf6", "fontSize": "15px", "fontFamily": "'Segoe UI', 'Helvetica Neue', Arial, sans-serif", "edgeLabelBackground": "#ffffffee", "clusterBkg": "#f8f9fa", "clusterBorder": "#dee2e6"}, "flowchart": {"useMaxWidth": false, "htmlLabels": true, "curve": "basis", "padding": 24, "nodeSpacing": 50, "rankSpacing": 60}}}%%

flowchart TD
    Start(["User Request"]) --> Recon["Parent does lightweight recon<br/><i>Glob/Grep for IaC, APIs, data stores</i>"]
    Recon --> Mode{"Solo or Team?"}

    %% Solo Path
    Mode -->|"Small system,<br/>no sensitive data,<br/>no IaC"| Solo_SA1["<b>security-architect</b><br/><i>blocking</i><br/>Phase 1 only"]
    Solo_SA1 -->|"01-reconnaissance.md"| Solo_DS1["<b>diagram-specialist</b><br/><i>blocking</i><br/>Phase 2: structural DFDs"]
    Solo_DS1 -->|"02-structural-diagram.md"| Solo_SA2["<b>security-architect</b><br/><i>blocking</i><br/>Phases 3-6, 8 summary"]
    Solo_SA2 -->|"03-06.md, 08.md"| Solo_DS2["<b>diagram-specialist</b><br/><i>blocking</i><br/>Phase 7: risk overlay"]
    Solo_DS2 -->|"07-final-diagram.md"| Solo_RA["<b>report-analyst</b><br/><i>blocking</i><br/>QA + Generate 4 formats"]
    Solo_RA --> Solo_Done(["Solo Complete<br/><b>report.html, .docx, .pdf, .pptx</b>"])

    %% Team Path
    Mode -->|"Complex system,<br/>PII/PHI, cloud IaC,<br/>compliance needs"| Team_SA1["<b>security-architect</b><br/><i>blocking</i><br/>Phase 1 only"]

    Team_SA1 -->|"01-reconnaissance.md"| Team_DS1["<b>diagram-specialist</b><br/><i>blocking</i><br/>Phase 2: structural DFDs"]
    Team_DS1 -->|"02-structural-diagram.md"| Team_SA2["<b>security-architect</b><br/><i>blocking</i><br/>Phases 3-6, 8 summary"]
    Team_SA2 -->|"03-06.md, 08.md"| Team_DS2["<b>diagram-specialist</b><br/><i>blocking</i><br/>Phase 7: risk overlay"]

    Team_DS2 -->|"07-final-diagram.md"| Fork["Parent spawns<br/>3 agents in parallel"]

    Fork --> PA["<b>privacy-agent</b><br/><i>background</i>"]
    Fork --> GRC["<b>grc-agent</b><br/><i>background</i>"]
    Fork --> CR["<b>code-review-agent</b><br/><i>background</i>"]

    PA -->|"privacy-assessment.md"| Join["Parent waits for all 3<br/><i>TaskOutput, block=true</i>"]
    GRC -->|"compliance-gap-analysis.md"| Join
    CR -->|"code-security-review.md"| Join

    Join --> VS["<b>validation-specialist</b><br/><i>blocking, as general-purpose</i><br/>Dedup, verify IDs,<br/>severity consistency"]

    VS -->|"validation-report.md"| Team_RA["<b>report-analyst</b><br/><i>blocking</i><br/>QA + Consolidate +<br/>Generate 4 formats"]

    Team_RA --> Team_Done(["Team Complete<br/><b>report.html, .docx, .pdf, .pptx</b>"])

    %% Verify
    Solo_Done --> Verify["Parent verifies all files<br/>exist and are non-empty"]
    Team_Done --> Verify

    classDef start fill:#e0f2fe,stroke:#0284c7,stroke-width:2px,color:#0c4a6e
    classDef decision fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#78350f
    classDef agent fill:#f0fdf4,stroke:#22c55e,stroke-width:1.5px,color:#14532d
    classDef diagram fill:#e0f2fe,stroke:#0284c7,stroke-width:1.5px,color:#0c4a6e
    classDef post fill:#fef3c7,stroke:#f59e0b,stroke-width:1.5px,color:#78350f
    classDef done fill:#f0fdf4,stroke:#16a34a,stroke-width:2px,color:#14532d
    classDef control fill:#f3e8ff,stroke:#a855f7,stroke-width:1.5px,color:#581c87

    class Start,Solo_Done,Team_Done,Verify start
    class Mode decision
    class Solo_SA1,Solo_SA2,Team_SA1,Team_SA2,PA,GRC,CR,Solo_RA,Team_RA agent
    class Solo_DS1,Solo_DS2,Team_DS1,Team_DS2 diagram
    class Fork,Join control
    class VS post
